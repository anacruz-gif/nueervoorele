<!DOCTYPE html>
<html>
<head>
    <title>Control de Electrovalvula</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #2c3e50; color: white; }
        .container { margin-top: 50px; }
        .led-container { display: flex; justify-content: center; gap: 50px; margin: 30px; }
        
        /* Estilo de los focos redondos */
        .led {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 4px solid #333;
            transition: 0.3s;
        }
        .led-on { background-color: #004400; box-shadow: 0 0 5px #000; }
        .led-on.active { background-color: #2ecc71; box-shadow: 0 0 20px #2ecc71; }
        
        .led-off { background-color: #440000; box-shadow: 0 0 5px #000; }
        .led-off.active { background-color: #e74c3c; box-shadow: 0 0 20px #e74c3c; }

        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 8px; border: none; margin: 10px; }
        .btn-connect { background: #3498db; color: white; }
        .btn-on { background: #2ecc71; color: white; }
        .btn-off { background: #e74c3c; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Control de Electrovalvula</h1>
        <button class="btn-connect" onclick="conectarBLE()">Conectar ESP32</button>
        
        <div class="led-container">
            <div>
                <div id="focoOn" class="led led-on"></div>
                <p>ENCENDIDA</p>
            </div>
            <div>
                <div id="focoOff" class="led led-off active"></div>
                <p>APAGADA</p>
            </div>
        </div>

        <div>
            <button class="btn-on" onclick="enviarComando('ON')">ABRIR (ON)</button>
            <button class="btn-off" onclick="enviarComando('OFF')">CERRAR (OFF)</button>
        </div>
        <h2 id="temp">Temperatura: -- °C</h2>
    </div>

    <script>
        let caracteristica;
        const SERVICE_UUID = "12345678-1234-1234-1234-123456789abc";
        const CHAR_UUID = "87654321-4321-4321-4321-cba987654321";

        async function conectarBLE() {
            try {
                const dispositivo = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32_Control_Valvula' }],
                    optionalServices: [SERVICE_UUID]
                });
                const servidor = await dispositivo.gatt.connect();
                const servicio = await servidor.getPrimaryService(SERVICE_UUID);
                caracteristica = await servicio.getCharacteristic(CHAR_UUID);
                
                // Recibir temperatura
                await caracteristica.startNotifications();
                caracteristica.addEventListener('characteristicvaluechanged', (e) => {
                    const valor = new TextDecoder().decode(e.target.value);
                    document.getElementById('temp').innerText = `Temperatura: ${valor} °C`;
                });
                alert("Conectado con éxito");
            } catch (error) { console.log(error); }
        }

        async function enviarComando(cmd) {
            if (caracteristica) {
                await caracteristica.writeValue(new TextEncoder().encode(cmd));
                // Actualizar focos en la web
                if(cmd === 'ON') {
                    document.getElementById('focoOn').classList.add('active');
                    document.getElementById('focoOff').classList.remove('active');
                } else {
                    document.getElementById('focoOn').classList.remove('active');
                    document.getElementById('focoOff').classList.add('active');
                }
            }
        }
    </script>
</body>
</html>
